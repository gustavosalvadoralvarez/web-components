<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">
<script src="../papaparse/papaparse.min.js"></script>
<script src="./lib/utils.js"></script>
<script src="../async/lib/async.js"></script>
<script src="../async/lib/async.js"></script>
<script src="../ydn.db/dist/ydn.db-is-core-e-qry-dev.js "></script>

<!--
An element providing a solution to no problem in particular.

Example:

    <indexed-db></indexed-db>

@demo
-->
<dom-module id="indexed-db-store">

  <style>

  </style>


  <template>
    <div class="content">
      <content></content>
    </div>
  </template>

</dom-module>

<script>

  Polymer({

    is: 'indexed-db-store',

    properties: {

    },


    attached : function() {
      var self, db, srcs, dbSchema;
      self = this;
      srcs = self.gatherDataSources();
      db = new ydn.db.Storage(self.dbName(), self.generateDBSchema(srcs));
      db.addEventListener('ready', 
        function (event) {
          var updated;
          updated = event.getVersion() !== event.getOldVersion();
          console.log(updated);
          console.log(event.getOldVersion());
          if (isNaN(event.getOldVersion())) {
            console.log('Database connected with new schema...');
            console.log('Running ETL on sources...');
            async.eachSeries(
              srcs,
              function etl(src, callback){ 
                console.log("Parsing: "+src.getAttribute('name')+"..."); 
                var srcTxt, srcName;
                srcTxt = utils.importText(src); 
                srcName = src.getAttribute('name'); 
                Papa.parse( 
                  utils.importText(src), 
                  {
                    complete: function(res){ 
                      if (res.errors.length > 0){
                        console.log("Parsing Error: ");
                        console.log(res.errors);
                        callback(err)
                        return 
                      }
                      var srcData, loadReq;
                      srcData = utils.JSON.fromCSVArray(res.data); 
                      console.log(db);
                      loadReq = db.addAll(srcName, srcData);
                      loadReq.done(
                        function(){ 
                          console.log("Succesfully loaded "+srcName+"!");
                          callback()
                        }
                      ); 
                      loadReq.fail(
                        function(e){ 
                          console.log("Database loading error: ");
                          console.log(e);
                          callback(e) 
                        }
                      );
                    }
                  }
                )
              },
              function(err){
                if (err){
                  console.log(err);
                  return
                }
                console.log("ETL successful!");
              }
            );
          }  else if(updated){ 
            console.log("Database loaded with new schema...");
          } else {
            console.log('existing database connected');
          }
        }
      );
    },

    gatherDataSources: function(){
      var self = this;
      return utils.asArray(self.querySelectorAll('.source'))
    },
    generateDBSchema: function(dataSources){ 
      var self;
      self = this;
      return {
        stores: dataSources.map(
          function(el){
            var srcName;
            srcName = el.getAttribute('name');
            return utils.JSON.import(self.querySelector('.schema[name="'+srcName+'"]'));
          }
        )
      } 
    },
    dbName: function(){ 
      return document.querySelector("TITLE").textContent
    },

    sniffDataLinks: function(dataLinks){
      return dataLinks.map(utils.textContent).map(
        function(dtx){
          var rows, first, nrows; 
          rows = dtx.split('\n'); 
          first = utils.car(rows).split(',');
          nrows = rows.length;
          return { 
            cols: first,
            nrows: nrows
          }

        }
      )
    }

  });

</script>
